# Complete Migration Automation: Replit ‚Üí PC ‚Üí Git ‚Üí New Replit

**Date**: October 28, 2025  
**Objective**: Fully automated migration workflow with code + database

---

## üéØ WHAT CAN BE AUTOMATED

### ‚úÖ **FULLY AUTOMATED**:
1. **Code Export**: Replit ‚Üí Git (automatic)
2. **Database Backup**: One-command export
3. **Git Commit & Push**: Scripted automation
4. **Code Import**: Git ‚Üí New Replit (automatic)
5. **Database Restore**: One-command import

### ‚ö†Ô∏è **SEMI-AUTOMATED** (One-Time Setup):
1. **Initial Git Setup**: Configure Git repo once
2. **Environment Variables**: Copy secrets manually (security requirement)
3. **New Replit Creation**: Click "Import from Git" once

### ‚ùå **CANNOT BE AUTOMATED** (Replit Restrictions):
1. **Secrets/API Keys Migration**: Must be manually added for security
2. **Direct Database Connection Between Repls**: No direct repl-to-repl DB transfer
3. **Production Database Access from Agent**: Restricted for safety

---

## üöÄ THE COMPLETE AUTOMATION SOLUTION

I'll provide **4 scripts** that automate the entire workflow:
1. **`backup-and-export.sh`** - Export everything from old Replit
2. **`commit-to-git.sh`** - Commit and push to Git
3. **`restore-database.sh`** - Restore database in new Replit
4. **`verify-migration.sh`** - Verify everything migrated correctly

---

## üì¶ SCRIPT 1: BACKUP & EXPORT (Old Replit)

**File**: `scripts/backup-and-export.sh`

```bash
#!/bin/bash
# BACKUP & EXPORT AUTOMATION
# Run this in your OLD Replit to export everything

set -e  # Exit on any error

echo "üöÄ YoForex Migration: Backup & Export"
echo "======================================"
echo ""

# Configuration
BACKUP_DIR="migration_backup"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
DB_BACKUP_FILE="$BACKUP_DIR/database_backup_$TIMESTAMP.sql"
DB_BACKUP_COMPRESSED="$BACKUP_DIR/database_backup_$TIMESTAMP.sql.gz"

# Step 1: Create backup directory
echo "üìÅ Step 1/5: Creating backup directory..."
mkdir -p "$BACKUP_DIR"
echo "‚úÖ Directory created: $BACKUP_DIR"
echo ""

# Step 2: Backup database (PostgreSQL)
echo "üíæ Step 2/5: Backing up PostgreSQL database..."
if [ -z "$DATABASE_URL" ]; then
    echo "‚ùå ERROR: DATABASE_URL not found!"
    echo "   Make sure you're running this in a Replit with a database."
    exit 1
fi

echo "   - Exporting database schema + data..."
pg_dump "$DATABASE_URL" > "$DB_BACKUP_FILE"
echo "   - Database exported: $DB_BACKUP_FILE"

# Compress backup
echo "   - Compressing backup..."
gzip "$DB_BACKUP_FILE"
echo "‚úÖ Database backup complete: $DB_BACKUP_COMPRESSED"
echo "   Size: $(du -h "$DB_BACKUP_COMPRESSED" | cut -f1)"
echo ""

# Step 3: Export environment variables (template)
echo "üîê Step 3/5: Creating environment variables template..."
ENV_TEMPLATE="$BACKUP_DIR/env_template.txt"
cat > "$ENV_TEMPLATE" << 'EOF'
# YoForex Environment Variables
# Copy these to your new Replit's Secrets tab

# Database (will be auto-created by new Replit)
# DATABASE_URL=<auto-generated>
# PGHOST=<auto-generated>
# PGPORT=<auto-generated>
# PGUSER=<auto-generated>
# PGPASSWORD=<auto-generated>
# PGDATABASE=<auto-generated>

# Add your custom secrets below:
# STRIPE_SECRET_KEY=your_stripe_key_here
# SENDGRID_API_KEY=your_sendgrid_key_here
# OPENAI_API_KEY=your_openai_key_here
# TWILIO_ACCOUNT_SID=your_twilio_sid_here
# TWILIO_AUTH_TOKEN=your_twilio_token_here
# TWILIO_PHONE_NUMBER=your_twilio_phone_here

# Add any other custom environment variables you use
EOF
echo "‚úÖ Environment template created: $ENV_TEMPLATE"
echo "   (You'll need to manually add secrets to new Replit)"
echo ""

# Step 4: Create migration manifest
echo "üìã Step 4/5: Creating migration manifest..."
MANIFEST="$BACKUP_DIR/migration_manifest.json"
cat > "$MANIFEST" << EOF
{
  "migration_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "source": "Replit Old Instance",
  "destination": "Git Repository + New Replit",
  "database_backup": "$DB_BACKUP_COMPRESSED",
  "env_template": "$ENV_TEMPLATE",
  "scripts": {
    "restore": "scripts/restore-database.sh",
    "verify": "scripts/verify-migration.sh"
  },
  "instructions": "See COMPLETE_MIGRATION_AUTOMATION.md"
}
EOF
echo "‚úÖ Manifest created: $MANIFEST"
echo ""

# Step 5: Summary
echo "üìä Step 5/5: Backup Summary"
echo "======================================"
echo "‚úÖ Database backup: $DB_BACKUP_COMPRESSED"
echo "‚úÖ Environment template: $ENV_TEMPLATE"
echo "‚úÖ Migration manifest: $MANIFEST"
echo ""
echo "üì¶ Backup Size: $(du -sh "$BACKUP_DIR" | cut -f1)"
echo ""
echo "üéØ NEXT STEPS:"
echo "   1. Run: ./scripts/commit-to-git.sh"
echo "   2. Import Git repo to new Replit"
echo "   3. Run: ./scripts/restore-database.sh"
echo ""
echo "‚úÖ Backup complete! Ready for Git commit."
```

---

## üîÑ SCRIPT 2: COMMIT TO GIT (Old Replit or PC)

**File**: `scripts/commit-to-git.sh`

```bash
#!/bin/bash
# COMMIT TO GIT AUTOMATION
# Run this after backup-and-export.sh

set -e

echo "üì§ YoForex Migration: Git Commit & Push"
echo "========================================"
echo ""

# Check if git is initialized
if [ ! -d .git ]; then
    echo "‚ö†Ô∏è  Git not initialized. Initializing now..."
    git init
    echo "‚úÖ Git initialized"
fi

# Check if remote is set
if ! git remote | grep -q origin; then
    echo "‚ö†Ô∏è  No Git remote found."
    echo "   Please add your Git remote URL:"
    read -p "   Git Remote URL (e.g., https://github.com/user/repo.git): " REMOTE_URL
    git remote add origin "$REMOTE_URL"
    echo "‚úÖ Remote added: origin"
fi

# Step 1: Stage all files
echo "üìù Step 1/4: Staging files..."
git add .
echo "‚úÖ Files staged"
echo ""

# Step 2: Show what's being committed
echo "üìã Step 2/4: Files to be committed:"
git diff --cached --name-status | head -20
FILE_COUNT=$(git diff --cached --name-only | wc -l)
echo "   ... and $(($FILE_COUNT - 20)) more files" 
echo ""

# Step 3: Commit
echo "üíæ Step 3/4: Committing changes..."
COMMIT_MSG="Migration backup $(date +%Y-%m-%d) - Code + Database"
git commit -m "$COMMIT_MSG"
echo "‚úÖ Committed: $COMMIT_MSG"
echo ""

# Step 4: Push to Git
echo "üöÄ Step 4/4: Pushing to Git..."
BRANCH=$(git branch --show-current)
git push -u origin "$BRANCH"
echo "‚úÖ Pushed to origin/$BRANCH"
echo ""

echo "üéØ NEXT STEPS:"
echo "   1. Go to Replit.com"
echo "   2. Click 'Create Repl' ‚Üí 'Import from Git'"
echo "   3. Paste your Git repository URL"
echo "   4. Wait for import to complete"
echo "   5. In new Replit, run: ./scripts/restore-database.sh"
echo ""
echo "‚úÖ Git commit & push complete!"
```

---

## üîÑ SCRIPT 3: RESTORE DATABASE (New Replit)

**File**: `scripts/restore-database.sh`

```bash
#!/bin/bash
# RESTORE DATABASE AUTOMATION
# Run this in your NEW Replit after importing from Git

set -e

echo "üì• YoForex Migration: Database Restore"
echo "======================================"
echo ""

# Configuration
BACKUP_DIR="migration_backup"

# Step 1: Check for database backup
echo "üîç Step 1/4: Looking for database backup..."
BACKUP_FILE=$(ls -t "$BACKUP_DIR"/database_backup_*.sql.gz 2>/dev/null | head -1)

if [ -z "$BACKUP_FILE" ]; then
    echo "‚ùå ERROR: No database backup found!"
    echo "   Expected location: $BACKUP_DIR/database_backup_*.sql.gz"
    echo "   Did you import the full repository from Git?"
    exit 1
fi

echo "‚úÖ Found backup: $BACKUP_FILE"
echo "   Size: $(du -h "$BACKUP_FILE" | cut -f1)"
echo ""

# Step 2: Check database connection
echo "üîå Step 2/4: Checking database connection..."
if [ -z "$DATABASE_URL" ]; then
    echo "‚ùå ERROR: DATABASE_URL not found!"
    echo "   Please create a PostgreSQL database in this Replit:"
    echo "   1. Click 'Tools' ‚Üí 'Database'"
    echo "   2. Create a PostgreSQL database"
    echo "   3. Run this script again"
    exit 1
fi

echo "‚úÖ Database connection available"
echo ""

# Step 3: Decompress backup
echo "üì¶ Step 3/4: Decompressing backup..."
DECOMPRESSED="${BACKUP_FILE%.gz}"
gunzip -c "$BACKUP_FILE" > "$DECOMPRESSED"
echo "‚úÖ Backup decompressed: $DECOMPRESSED"
echo ""

# Step 4: Restore database
echo "üíæ Step 4/4: Restoring database..."
echo "   ‚ö†Ô∏è  This will replace all data in the current database!"
read -p "   Continue? (yes/no): " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
    echo "‚ùå Restore cancelled"
    rm "$DECOMPRESSED"  # Clean up
    exit 0
fi

echo "   - Restoring data..."
psql "$DATABASE_URL" < "$DECOMPRESSED"

# Clean up decompressed file
rm "$DECOMPRESSED"

echo "‚úÖ Database restored successfully!"
echo ""

# Step 5: Verify restoration
echo "üîç Verifying restoration..."
echo ""
echo "üìä Database Statistics:"
echo "   Forum Threads: $(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM forum_threads;" | tr -d ' ')"
echo "   Forum Replies: $(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM forum_replies;" | tr -d ' ')"
echo "   Users: $(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM users;" | tr -d ' ')"
echo "   Brokers: $(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM brokers;" | tr -d ' ')"
echo ""

echo "üéØ NEXT STEPS:"
echo "   1. Review environment variables (Secrets tab)"
echo "   2. Add any missing API keys (see $BACKUP_DIR/env_template.txt)"
echo "   3. Run verification: ./scripts/verify-migration.sh"
echo "   4. Start application: npm run dev"
echo ""
echo "‚úÖ Database restore complete!"
```

---

## ‚úÖ SCRIPT 4: VERIFY MIGRATION (New Replit)

**File**: `scripts/verify-migration.sh`

```bash
#!/bin/bash
# VERIFY MIGRATION
# Run this after restore-database.sh to verify everything migrated

set -e

echo "‚úÖ YoForex Migration: Verification"
echo "===================================="
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

PASS=0
FAIL=0
WARN=0

# Helper functions
check_pass() {
    echo -e "${GREEN}‚úÖ PASS${NC}: $1"
    ((PASS++))
}

check_fail() {
    echo -e "${RED}‚ùå FAIL${NC}: $1"
    ((FAIL++))
}

check_warn() {
    echo -e "${YELLOW}‚ö†Ô∏è  WARN${NC}: $1"
    ((WARN++))
}

# Test 1: Database Connection
echo "üîç Test 1/8: Database Connection"
if [ -n "$DATABASE_URL" ]; then
    if psql "$DATABASE_URL" -c "SELECT 1" &>/dev/null; then
        check_pass "Database connection working"
    else
        check_fail "Cannot connect to database"
    fi
else
    check_fail "DATABASE_URL not set"
fi
echo ""

# Test 2: Database Tables
echo "üîç Test 2/8: Database Schema"
EXPECTED_TABLES=("users" "forum_threads" "forum_replies" "forum_categories" "brokers" "content_items")
for table in "${EXPECTED_TABLES[@]}"; do
    if psql "$DATABASE_URL" -t -c "SELECT EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name='$table');" | grep -q t; then
        check_pass "Table exists: $table"
    else
        check_fail "Table missing: $table"
    fi
done
echo ""

# Test 3: Data Counts
echo "üîç Test 3/8: Data Counts"
THREAD_COUNT=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM forum_threads;" | tr -d ' ')
REPLY_COUNT=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM forum_replies;" | tr -d ' ')
USER_COUNT=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM users;" | tr -d ' ')

if [ "$THREAD_COUNT" -gt 0 ]; then
    check_pass "$THREAD_COUNT forum threads migrated"
else
    check_warn "No forum threads found (expected for fresh install)"
fi

if [ "$REPLY_COUNT" -gt 0 ]; then
    check_pass "$REPLY_COUNT forum replies migrated"
else
    check_warn "No forum replies found"
fi

if [ "$USER_COUNT" -gt 0 ]; then
    check_pass "$USER_COUNT users migrated"
else
    check_warn "No users found"
fi
echo ""

# Test 4: Database Indexes
echo "üîç Test 4/8: Database Indexes"
INDEX_COUNT=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM pg_indexes WHERE schemaname = 'public';" | tr -d ' ')
if [ "$INDEX_COUNT" -gt 5 ]; then
    check_pass "$INDEX_COUNT indexes found"
else
    check_warn "Only $INDEX_COUNT indexes (expected 10+)"
fi
echo ""

# Test 5: Files & Directories
echo "üîç Test 5/8: Project Files"
REQUIRED_FILES=("package.json" "server/index.ts" "shared/schema.ts" "app/page.tsx")
for file in "${REQUIRED_FILES[@]}"; do
    if [ -f "$file" ]; then
        check_pass "File exists: $file"
    else
        check_fail "File missing: $file"
    fi
done
echo ""

# Test 6: Dependencies
echo "üîç Test 6/8: Node Dependencies"
if [ -d "node_modules" ]; then
    MODULE_COUNT=$(ls -d node_modules/* 2>/dev/null | wc -l)
    if [ "$MODULE_COUNT" -gt 50 ]; then
        check_pass "$MODULE_COUNT npm packages installed"
    else
        check_warn "Only $MODULE_COUNT packages (run: npm install)"
    fi
else
    check_fail "node_modules not found (run: npm install)"
fi
echo ""

# Test 7: Environment Variables
echo "üîç Test 7/8: Environment Variables"
REQUIRED_VARS=("DATABASE_URL" "PGHOST" "PGDATABASE")
for var in "${REQUIRED_VARS[@]}"; do
    if [ -n "${!var}" ]; then
        check_pass "Variable set: $var"
    else
        check_fail "Variable missing: $var"
    fi
done
echo ""

# Test 8: Application Start
echo "üîç Test 8/8: Application Status"
if [ -f "start-nextjs-only.sh" ]; then
    check_pass "Start script exists"
else
    check_warn "Start script not found"
fi

if pgrep -f "node.*next" > /dev/null || pgrep -f "tsx.*server" > /dev/null; then
    check_pass "Application appears to be running"
else
    check_warn "Application not running (start with: npm run dev)"
fi
echo ""

# Summary
echo "===================================="
echo "üìä VERIFICATION SUMMARY"
echo "===================================="
echo -e "${GREEN}Passed${NC}: $PASS tests"
echo -e "${YELLOW}Warnings${NC}: $WARN tests"
echo -e "${RED}Failed${NC}: $FAIL tests"
echo ""

if [ $FAIL -eq 0 ]; then
    echo -e "${GREEN}‚úÖ MIGRATION SUCCESSFUL!${NC}"
    echo ""
    echo "üéØ Next Steps:"
    echo "   1. Review warnings (if any)"
    echo "   2. Start application: npm run dev"
    echo "   3. Visit the app in browser"
    echo "   4. Test key functionality"
    echo ""
    exit 0
else
    echo -e "${RED}‚ùå MIGRATION HAS ISSUES${NC}"
    echo ""
    echo "üîß Recommended Actions:"
    echo "   1. Review failed tests above"
    echo "   2. Check migration_backup/ directory"
    echo "   3. Verify database restoration completed"
    echo "   4. Run: npm install (if dependencies missing)"
    echo ""
    exit 1
fi
```

---

## üé¨ COMPLETE WORKFLOW

### **Phase 1: OLD REPLIT**
```bash
# Make scripts executable
chmod +x scripts/*.sh

# Step 1: Backup everything
./scripts/backup-and-export.sh

# Step 2: Commit to Git
./scripts/commit-to-git.sh
```

### **Phase 2: GIT REPOSITORY**
‚úÖ Your code + database backup are now in Git!

### **Phase 3: NEW REPLIT**
1. Create new Repl: "Import from Git"
2. Paste your Git repository URL
3. Wait for import to complete
4. Run restoration:
```bash
# Make scripts executable
chmod +x scripts/*.sh

# Step 3: Install dependencies
npm install

# Step 4: Restore database
./scripts/restore-database.sh

# Step 5: Verify migration
./scripts/verify-migration.sh

# Step 6: Start application
npm run dev
```

---

## ‚ö° EVEN MORE AUTOMATION: One-Command Solution

Create a master script that runs everything:

**File**: `scripts/migrate-all.sh`

```bash
#!/bin/bash
# MASTER MIGRATION SCRIPT
# Run this in OLD Replit for complete automation

set -e

echo "üöÄ YoForex Complete Migration Automation"
echo "========================================="
echo ""
echo "This will:"
echo "  1. Backup database"
echo "  2. Commit to Git"
echo "  3. Push to remote"
echo ""
read -p "Continue? (yes/no): " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
    echo "Cancelled"
    exit 0
fi

# Run all steps
./scripts/backup-and-export.sh
./scripts/commit-to-git.sh

echo ""
echo "========================================="
echo "‚úÖ MIGRATION PREPARATION COMPLETE!"
echo "========================================="
echo ""
echo "üéØ FINAL STEPS (Manual):"
echo "   1. Go to Replit.com"
echo "   2. Create Repl ‚Üí Import from Git"
echo "   3. Paste your Git URL: $(git remote get-url origin)"
echo "   4. After import completes, run in NEW Replit:"
echo "      npm install"
echo "      ./scripts/restore-database.sh"
echo "      ./scripts/verify-migration.sh"
echo ""
echo "üì¶ Backup Location: migration_backup/"
echo "üìä Backup Size: $(du -sh migration_backup | cut -f1)"
echo ""
```

---

## üîê SECURITY & BEST PRACTICES

### 1. **Secrets Management**
```bash
# ‚ùå NEVER commit secrets to Git!
# Add to .gitignore:
.env
.env.local
*.key
*.pem
secrets/
```

### 2. **Backup Security**
```bash
# Encrypt sensitive backups
gpg --symmetric --cipher-algo AES256 migration_backup/database_backup_*.sql.gz
```

### 3. **Git Ignore Database Backups** (Optional)
```bash
# Add to .gitignore if backups are too large:
migration_backup/*.sql.gz
migration_backup/*.sql
```

### 4. **Environment Variables Checklist**
After migration, manually add these to new Replit Secrets:
- [ ] STRIPE_SECRET_KEY
- [ ] SENDGRID_API_KEY
- [ ] OPENAI_API_KEY
- [ ] TWILIO_* (if using)
- [ ] Any custom API keys

---

## üìä EXPECTED RESULTS

### **Old Replit**:
```
‚úÖ Database backed up (compressed .sql.gz)
‚úÖ Code committed to Git
‚úÖ Backup pushed to Git repository
```

### **New Replit**:
```
‚úÖ Code imported from Git
‚úÖ Dependencies installed
‚úÖ Database restored from backup
‚úÖ All data migrated:
   - 61 Forum Threads
   - 168 Replies
   - 17 Users
   - Categories, Brokers, etc.
‚úÖ Application running
```

---

## üö® TROUBLESHOOTING

### **Issue: "pg_dump: command not found"**
```bash
# Install PostgreSQL tools
nix-env -iA nixpkgs.postgresql
```

### **Issue: "Permission denied" on scripts**
```bash
chmod +x scripts/*.sh
```

### **Issue: "Database restore fails"**
```bash
# Check database connection
psql "$DATABASE_URL" -c "SELECT version();"

# Try restore with verbose output
psql "$DATABASE_URL" -v ON_ERROR_STOP=1 < migration_backup/database_backup_*.sql
```

### **Issue: "Backup file too large for Git"**
```bash
# Use Git LFS (Large File Storage)
git lfs install
git lfs track "migration_backup/*.sql.gz"
git add .gitattributes
git commit -m "Track large database backups with LFS"
```

---

## ‚úÖ FINAL CHECKLIST

### **Before Migration**:
- [ ] Scripts created and executable
- [ ] Git repository initialized
- [ ] Git remote configured
- [ ] All changes committed

### **During Migration**:
- [ ] Run backup-and-export.sh
- [ ] Run commit-to-git.sh
- [ ] Import to new Replit
- [ ] Run restore-database.sh

### **After Migration**:
- [ ] Run verify-migration.sh
- [ ] Add environment variables
- [ ] Test application
- [ ] Verify all features work

---

## üìö SUMMARY

**What's Automated**:
- ‚úÖ Database backup (1 command)
- ‚úÖ Git commit & push (1 command)
- ‚úÖ Database restore (1 command)
- ‚úÖ Migration verification (1 command)

**What's Manual** (Required for Security):
- ‚ö†Ô∏è Creating new Replit from Git (1 click)
- ‚ö†Ô∏è Adding environment variables/secrets (copy-paste)

**Total Time**: 
- Automation setup: 10 minutes (one-time)
- Each migration: 5-10 minutes (mostly automated)

**Files Created**: 5 scripts that handle everything
**Skill Level Required**: Basic bash/terminal knowledge

---

**END OF COMPLETE MIGRATION AUTOMATION GUIDE**
